name: Free Disk Space (Ubuntu)

on:
  push:
    branches:
      - main
    paths-ignore:
      - "*.md"
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Runs every 15 days at 02:00 UTC
    - cron: '0 2 */15 * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  shellcheck:
    name: "Bashscript Linter"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install shellcheck -y

      - name: Run ShellCheck
        run: shellcheck main.sh -o all -e SC2033,SC2032
  
  # Basic usage test
  test_basic:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Basic test"
      remove_android: true
      remove_dotnet: true

  # Full cleanup test
  test_full:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Full cleanup"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_tool_cache: true
      remove_swap: true
      remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda"

  # Package removal test (one command)
  test_packages_one_command:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Packages one command"
      remove_packages: "postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
      remove_packages_one_command: true

  # Package removal test (individual commands)
  test_packages_individual:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Packages individual"
      remove_packages: "postgresql* temurin-* *llvm*"
      remove_packages_one_command: false

  # Folders removal test
  test_folders:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folders removal"
      remove_folders: "/usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell"

  # Tool cache and swap test
  test_tool_cache_swap:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Tool cache and swap"
      remove_tool_cache: true
      remove_swap: true

  # Test Haskell removal specifically
  test_haskell:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Haskell removal"
      remove_haskell: true

  # Large removal test
  test_large_removal:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Large removal"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_tool_cache: true
      remove_swap: true
      remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-* julia*"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/share/glade* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"

  # Quick test for PR validation - .NET
  quick_test_dotnet:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Quick .NET test"
      remove_dotnet: true

  # Quick test for PR validation - Android
  quick_test_android:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Quick Android test"
      remove_android: true

  # Quick test for PR validation - Packages
  quick_test_packages:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Quick packages test"
      remove_packages: "azure-cli google-cloud-cli firefox"
      remove_packages_one_command: true

  # Test with testing mode enabled
  quick_test_testing_mode:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Testing mode"
      testing: true

  # Individual folder tests for accurate Size Savings table
  test_folder_swift:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/share/swift"
      remove_folders: "/usr/share/swift"

  test_folder_miniconda:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/share/miniconda"
      remove_folders: "/usr/share/miniconda"

  test_folder_az:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/share/az*"
      remove_folders: "/usr/share/az*"

  test_folder_node_modules:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/local/lib/node_modules"
      remove_folders: "/usr/local/lib/node_modules"

  test_folder_chromium:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/local/share/chromium"
      remove_folders: "/usr/local/share/chromium"

  test_folder_powershell:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/local/share/powershell"
      remove_folders: "/usr/local/share/powershell"

  test_folder_aws_cli:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/local/aws-cli"
      remove_folders: "/usr/local/aws-cli"

  test_folder_aws_sam_cli:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/local/aws-sam-cli"
      remove_folders: "/usr/local/aws-sam-cli"

  test_folder_julia:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/local/julia"
      remove_folders: "/usr/local/julia"

  test_folder_gradle:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/share/gradle"
      remove_folders: "/usr/share/gradle"

  test_folder_glade:
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder: /usr/share/glade*"
      remove_folders: "/usr/share/glade*"
