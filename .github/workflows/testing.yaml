name: Free Disk Space (Ubuntu)

on:
  push:
    branches:
      - main
    paths-ignore:
      - "*.md"
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Runs every 15 days at 02:00 UTC
    - cron: '0 2 */15 * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Step 1: Linter
  shellcheck:
    name: "ðŸ” Bashscript Linter"
    runs-on: ubuntu-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install shellcheck -y

      - name: Run ShellCheck
        run: shellcheck main.sh -o all -e SC2033,SC2032
  
  # Step 2: Search biggest folders and packages
  search_biggest:
    name: "ðŸ” Search Biggest (${{ matrix.runner }})"
    needs: shellcheck
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-24.04, ubuntu-22.04, ubuntu-24.04-arm, ubuntu-slim]
    steps:
      - name: Show initial disk space
        run: |
          echo "ðŸ–¥ï¸ Runner: ${{ matrix.runner }}"
          echo "================================"
          df -h

      - name: Search biggest folders
        run: |
          echo "=== ðŸ“‚ SEARCHING BIGGEST FOLDERS ==="
          FOLDERS=(/etc /opt /home /var /usr /usr/share /usr/lib /usr/bin /usr/local/lib /usr/local/bin /usr/local/share)
          
          for folder in "${FOLDERS[@]}"; do
            if [ -d "$folder" ]; then
              echo ""
              echo "ðŸ“ Folder: $folder"
              echo "Total size:"
              sudo du -sh "$folder" 2>/dev/null || echo "Cannot access $folder"
              echo ""
              echo "Breakdown (2 levels deep):"
              sudo du -h --max-depth=2 "$folder" 2>/dev/null | sort -hr | head -20 || echo "Cannot access subdirectories of $folder"
              echo "=========================================="
            fi
          done

      - name: Show all packages by size
        run: |
          echo "=== ðŸ“¦ TOP 50 PACKAGES BY SIZE ==="
          dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n | tail -50

      - name: Show biggest files in key directories
        run: |
          echo "=== ðŸ“„ BIGGEST FILES IN /usr/bin ==="
          find /usr/bin -maxdepth 1 -type f -printf '%s %f\n' 2>/dev/null | sort -hr | head -20 | numfmt --to=iec-i --suffix=B --field=1 || echo "Cannot access /usr/bin"
          
          echo ""
          echo "=== ðŸ“„ BIGGEST FILES IN /usr/local/bin ==="
          find /usr/local/bin -maxdepth 1 -type f -printf '%s %f\n' 2>/dev/null | sort -hr | head -20 | numfmt --to=iec-i --suffix=B --field=1 || echo "Cannot access /usr/local/bin"


  # Step 3: Quick tests (for PRs)
  quick_test_dotnet:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Quick .NET test"
      remove_dotnet: true

  quick_test_android:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Quick Android test"
      remove_android: true

  quick_test_packages:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Quick packages test"
      remove_packages: "azure-cli google-cloud-cli firefox"
      remove_packages_one_command: true

  quick_test_testing_mode:
    needs: shellcheck
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/quick-test-template.yaml
    with:
      job_name: "Testing mode"
      testing: true

  # Step 4: Main tests (feature tests)
  test_basic:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Basic test"
      remove_android: true
      remove_dotnet: true

  test_full:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Full cleanup"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_tool_cache: true
      remove_swap: true
      remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda"

  # Package removal test (one command)
  test_packages_one_command:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Packages one command"
      remove_packages: "postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
      remove_packages_one_command: true

  # Package removal test (individual commands)
  test_packages_individual:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Packages individual"
      remove_packages: "postgresql* temurin-* *llvm*"
      remove_packages_one_command: false

  # Folders removal test
  test_folders:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folders removal"
      remove_folders: "/usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell"

  # Tool cache and swap test
  test_tool_cache_swap:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Tool cache and swap"
      remove_tool_cache: true
      remove_swap: true

  # Test Haskell removal specifically
  test_haskell:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Haskell removal"
      remove_haskell: true

  # Large removal test
  test_large_removal:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Large removal"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_tool_cache: true
      remove_swap: true
      remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-* julia*"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/share/glade* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"

  # User Reported: Full cleanup without tool_cache and swap (Issue 2025-12-08)
  # Tests apt mirror failures with temurin-* package removal
  test_user_reported_full_cleanup:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "User Reported: Full Cleanup"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda /usr/share/az* /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"

  # Use Case: Docker/Container Build (removes Android SDK 12GB + unused tools)
  test_usecase_docker:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Docker Build"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_packages: "google-cloud-cli azure-cli firefox google-chrome-stable microsoft-edge-stable"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/local/share/chromium /opt/hostedtoolcache"

  # Use Case: Python/ML Workflow (keeps Python, removes others)
  test_usecase_python_ml:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Python/ML"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_packages: "temurin-* *llvm* firefox google-chrome-stable microsoft-edge-stable"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/local/lib/node_modules /usr/local/share/chromium /usr/local/share/powershell"

  # Use Case: Node.js Project (keeps Node, removes heavy packages)
  test_usecase_nodejs:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Node.js"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_packages: "temurin-* google-cloud-cli azure-cli postgresql* mysql*"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda /usr/local/share/powershell"

  # Use Case: Java/JVM Project (keeps JDKs, removes others)
  test_usecase_java:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Java/JVM"
      remove_android: true
      remove_dotnet: true
      remove_haskell: true
      remove_packages: "*llvm* google-cloud-cli azure-cli firefox google-chrome-stable microsoft-edge-stable"
      remove_packages_one_command: true
      remove_folders: "/usr/share/swift /usr/share/miniconda /usr/local/lib/node_modules /usr/local/share/powershell"

  # Use Case: Remove all browsers (saves ~1.5GB)
  test_usecase_browsers:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Remove Browsers"
      remove_packages: "firefox google-chrome-stable microsoft-edge-stable chromium*"
      remove_packages_one_command: true
      remove_folders: "/usr/local/share/chromium /usr/lib/firefox"

  # Use Case: Remove cloud CLIs (saves ~1.5GB)
  test_usecase_cloud_tools:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Remove Cloud CLIs"
      remove_packages: "azure-cli google-cloud-cli google-cloud-cli-anthoscli"
      remove_packages_one_command: true
      remove_folders: "/usr/share/az* /usr/lib/google-cloud-sdk /opt/az /opt/google-cloud-sdk"

  # Use Case: Remove LLVM/Clang toolchain (saves ~2GB)
  test_usecase_llvm:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "UseCase: Remove LLVM"
      remove_packages: "*llvm* clang* libclang*"
      remove_packages_one_command: true
      remove_folders: "/usr/lib/llvm-*"

  # Step 5: Individual folder tests (for Size Savings table - only folders with >1GB savings)
  test_folder_swift:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder /usr/share/swift"
      remove_folders: "/usr/share/swift"

  test_folder_powershell:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder /usr/local/share/powershell"
      remove_folders: "/usr/local/share/powershell"

  # Test /opt folders (hostedtoolcache is huge on x86_64)
  test_folder_hostedtoolcache:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder /opt/hostedtoolcache"
      remove_folders: "/opt/hostedtoolcache"

  test_folder_dotnet:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder /usr/share/dotnet"
      remove_folders: "/usr/share/dotnet"

  test_folder_ghcup:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder /usr/local/.ghcup"
      remove_folders: "/usr/local/.ghcup"

  test_folder_android:
    needs: [shellcheck, search_biggest]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    uses: ./.github/workflows/test-template.yaml
    with:
      job_name: "Folder /usr/local/lib/android"
      remove_folders: "/usr/local/lib/android"

  # Step 6: Consolidated Summary
  consolidated_summary:
    name: "ðŸ“Š Test Summary Report"
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event_name == 'pull_request')
    needs: 
      # Core tests
      - test_basic
      - test_full
      - test_large_removal
      - test_user_reported_full_cleanup
      - test_packages_one_command
      - test_packages_individual
      - test_folders
      - test_tool_cache_swap
      - test_haskell
      # Use case tests
      - test_usecase_docker
      - test_usecase_python_ml
      - test_usecase_nodejs
      - test_usecase_java
      - test_usecase_browsers
      - test_usecase_cloud_tools
      - test_usecase_llvm
      # Quick tests (PRs only)
      - quick_test_dotnet
      - quick_test_android
      - quick_test_packages
      - quick_test_testing_mode
      # Folder tests (only high-impact folders)
      - test_folder_swift
      - test_folder_powershell
      - test_folder_hostedtoolcache
      - test_folder_dotnet
      - test_folder_ghcup
      - test_folder_android
    steps:
      - name: Download all test summaries
        uses: actions/download-artifact@v4
        with:
          pattern: test-summary-*
          path: all-summaries
          merge-multiple: true

      - name: Generate consolidated report
        run: |
          echo "# ðŸ“Š Free Disk Space - Test Results Summary" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d\ %H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verifica se existem summaries
          if [ ! -d "all-summaries" ] || [ -z "$(ls -A all-summaries 2>/dev/null)" ]; then
            echo "âš ï¸ No test summaries found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "## ðŸ“ˆ Results by Test Type" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Processa os arquivos JSON
          for json_file in all-summaries/*.json; do
            if [ -f "$json_file" ]; then
              JOB_NAME=$(jq -r '.job_name' "$json_file")
              RUNNER=$(jq -r '.runner' "$json_file")
              RM_CMD=$(jq -r '.rm_cmd' "$json_file")
              FREED=$(jq -r '.freed_space_gb' "$json_file")
              INITIAL=$(jq -r '.initial_space_gb' "$json_file")
              FINAL=$(jq -r '.final_space_gb' "$json_file")
              DURATION=$(jq -r '.duration_seconds' "$json_file")
              
              # Cria seÃ§Ã£o para cada teste
              echo "### ðŸ§ª $JOB_NAME" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| **Runner** | \`$RUNNER\` |" >> $GITHUB_STEP_SUMMARY
              echo "| **Removal Command** | \`$RM_CMD\` |" >> $GITHUB_STEP_SUMMARY
              echo "| **Initial Space** | ${INITIAL} GB |" >> $GITHUB_STEP_SUMMARY
              echo "| **Final Space** | ${FINAL} GB |" >> $GITHUB_STEP_SUMMARY
              echo "| **Duration** | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY
              
              # Calcula e formata o espaÃ§o liberado
              if [ "$FREED" -gt 0 ]; then
                echo "| **Space Freed** | âœ… **${FREED} GB** |" >> $GITHUB_STEP_SUMMARY
              elif [ "$FREED" -lt 0 ]; then
                echo "| **Space Freed** | âš ï¸ **${FREED} GB** (negative) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| **Space Freed** | â„¹ï¸ **${FREED} GB** |" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Mostra opÃ§Ãµes ativas
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>ðŸ“‹ Configuration Options</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              jq '.options' "$json_file" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # EstatÃ­sticas gerais
          echo "## ðŸ“Š Overall Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_TESTS=$(ls -1 all-summaries/*.json 2>/dev/null | wc -l)
          TOTAL_FREED=$(jq -s 'map(.freed_space_gb) | add' all-summaries/*.json)
          AVG_FREED=$(jq -s 'map(.freed_space_gb) | add / length' all-summaries/*.json)
          MAX_FREED=$(jq -s 'map(.freed_space_gb) | max' all-summaries/*.json)
          MIN_FREED=$(jq -s 'map(.freed_space_gb) | min' all-summaries/*.json)
          
          echo "| Statistic | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Space Freed | ${TOTAL_FREED} GB |" >> $GITHUB_STEP_SUMMARY
          echo "| Average Freed per Test | ${AVG_FREED} GB |" >> $GITHUB_STEP_SUMMARY
          echo "| Maximum Freed | ${MAX_FREED} GB |" >> $GITHUB_STEP_SUMMARY
          echo "| Minimum Freed | ${MIN_FREED} GB |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ComparaÃ§Ã£o rm vs rmz
          echo "## âš¡ Performance Comparison: rm vs rmz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          RM_AVG=$(jq -s 'map(select(.rm_cmd == "rm") | .freed_space_gb) | add / length' all-summaries/*.json)
          RMZ_AVG=$(jq -s 'map(select(.rm_cmd == "rmz") | .freed_space_gb) | add / length' all-summaries/*.json)
          
          echo "| Command | Average Space Freed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`rm\` | ${RM_AVG} GB |" >> $GITHUB_STEP_SUMMARY
          echo "| \`rmz\` | ${RMZ_AVG} GB |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ComparaÃ§Ã£o por runner
          echo "## ðŸ–¥ï¸ Results by Runner" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for runner in $(jq -r '.runner' all-summaries/*.json | sort -u); do
            RUNNER_AVG=$(jq -s --arg runner "$runner" 'map(select(.runner == $runner) | .freed_space_gb) | add / length' all-summaries/*.json)
            RUNNER_COUNT=$(jq -s --arg runner "$runner" 'map(select(.runner == $runner)) | length' all-summaries/*.json)
            
            echo "- **$runner**: ${RUNNER_AVG} GB average (${RUNNER_COUNT} tests)" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated automatically by Free Disk Space test suite*" >> $GITHUB_STEP_SUMMARY
